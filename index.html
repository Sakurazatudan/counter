<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>四角ブロック地球</title>
<style>
body { margin:0; overflow:hidden; background:#111; }
canvas { display:block; }
</style>
</head>
<body>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.158/build/three.module.js';

let scene, camera, renderer;
let earthGroup, waterGroup;

init();
animate();

function init() {
    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.set(3,3,5);
    camera.lookAt(0,0,0);

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5,5,5);
    scene.add(light);

    earthGroup = new THREE.Group();
    scene.add(earthGroup);

    waterGroup = new THREE.Group();
    earthGroup.add(waterGroup);

    createEarthBlocks();
}

// 四角グリッドで陸ブロック作成
function createEarthBlocks(){
    const gridSize = 16; // 16x16x16ブロック
    const blockSize = 0.2;

    for(let x=0; x<gridSize; x++){
        for(let z=0; z<gridSize; z++){
            const landHeight = Math.floor(Math.random()*8 + 4); // 4~11ブロックの高さ
            for(let y=0; y<landHeight; y++){
                const geometry = new THREE.BoxGeometry(blockSize, blockSize, blockSize);
                const material = new THREE.MeshStandardMaterial({color:0x228B22});
                const cube = new THREE.Mesh(geometry, material);
                cube.position.set(
                    (x-gridSize/2)*blockSize,
                    (y-gridSize/2)*blockSize,
                    (z-gridSize/2)*blockSize
                );
                earthGroup.add(cube);
            }
        }
    }
}

// 水ブロック描画
async function updateWaterLevel(ratio){
    while(waterGroup.children.length) waterGroup.remove(waterGroup.children[0]);

    const gridSize = 16;
    const blockSize = 0.2;
    const waterHeight = Math.floor(ratio * gridSize);

    for(let x=0; x<gridSize; x++){
        for(let z=0; z<gridSize; z++){
            for(let y=0; y<waterHeight; y++){
                const geometry = new THREE.BoxGeometry(blockSize, blockSize, blockSize);
                const material = new THREE.MeshStandardMaterial({color:0x1E90FF, transparent:true, opacity:0.6});
                const cube = new THREE.Mesh(geometry, material);
                cube.position.set(
                    (x-gridSize/2)*blockSize,
                    (y-gridSize/2)*blockSize,
                    (z-gridSize/2)*blockSize
                );
                waterGroup.add(cube);
            }
        }
    }
}

// JSONから人数割合取得
async function fetchMemberRatio(){
    try{
        const res = await fetch('member_count.json');
        const data = await res.json();
        const maxMembers = 1000;
        return Math.min(data.count / maxMembers, 1);
    }catch(e){
        console.error(e);
        return 0;
    }
}

async function animate(){
    requestAnimationFrame(animate);

    earthGroup.rotation.y += 0.002;
    earthGroup.position.y = Math.sin(Date.now()*0.001)*0.2;

    const ratio = await fetchMemberRatio();
    updateWaterLevel(ratio);

    renderer.render(scene, camera);
}
</script>
</body>
</html>
