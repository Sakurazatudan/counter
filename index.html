<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã¯ã¨ã‚ã’è£½é€ ãƒ©ã‚¤ãƒ³+å±±ç©ã¿</title>
<style>
body { margin:0; overflow:hidden; background:#87CEEB; }
canvas { display:block; }
#message {
  position:absolute;
  top:20px;
  width:100%;
  text-align:center;
  font-size:2em;
  color:#fff;
  font-family:sans-serif;
  text-shadow: 1px 1px 3px #000;
}
</style>
</head>
<body>
<div id="message"></div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const message = document.getElementById("message");

const hatoImg = new Image();
hatoImg.src = "hato.png";
const hatoAgeImg = new Image();
hatoAgeImg.src = "hatoage_only.png";

let count = 0;
let phase = "drop"; // drop â†’ fry â†’ fall â†’ fade â†’ pile
let fadeOpacity = 1.0;

let hato = { x: canvas.width/2-32, y: -80, size: 64, state:"raw" };
let pile = [];
let falling = [];

// JSON fetch
async function fetchCount() {
  try {
    const res = await fetch("member_count.json?" + new Date().getTime());
    const data = await res.json();
    count = Math.min(data.count, 1000);
  } catch (e) {
    console.error(e);
    count = 123; // ãƒ‡ãƒ¢ç”¨
  }
}
fetchCount();

// 1ç¾½ãŒå±±ã«è½ã¡ã‚‹
function spawnFalling() {
  if (pile.length + falling.length < count) {
    falling.push({
      x: canvas.width/2 + (Math.random()*100-50),
      y: -50,
      size: 48,
      speed: 5 + Math.random()*2
    });
  }
}
setInterval(spawnFalling, 200);

function update() {
  // è½ä¸‹å‡¦ç†
  for (let i=falling.length-1; i>=0; i--) {
    let f = falling[i];
    f.y += f.speed;
    if (f.y > canvas.height-80 - pile.length*0.2) { 
      pile.push({
        x: f.x + (Math.random()*20-10),
        y: canvas.height-80 - pile.length*0.2,
        size: f.size
      });
      falling.splice(i,1);
    }
  }

  // è£½é€ ãƒ©ã‚¤ãƒ³ â†’ ãƒ•ã‚§ãƒ¼ã‚ºåˆ¶å¾¡
  if (phase === "drop") {
    hato.y += 5;
    if (hato.y >= canvas.height/2 - 40) phase = "fry";
  } else if (phase==="fry") {
    setTimeout(()=>phase="fall", 500);
  } else if (phase==="fall") {
    hato.y += 6;
    if (hato.y > canvas.height) phase="fade";
  } else if (phase==="fade") {
    fadeOpacity -= 0.02;
    if(fadeOpacity <=0) phase="pile";
  }
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // ã‚ªãƒ¬ãƒ³ã‚¸ç«èŠ±ï¼ˆèƒŒé¢ï¼‰
  for(let i=0;i<20;i++){
    ctx.fillStyle = `rgba(255,165,0,${Math.random()*0.6})`;
    ctx.fillRect(Math.random()*canvas.width, canvas.height/2 - 20 + Math.random()*40, 3, 3);
  }

  // ç°è‰²æ£’ï¼ˆå‰é¢ãƒ»ç´°ã‚ï¼‰
  ctx.globalAlpha = fadeOpacity;
  ctx.fillStyle = "#555";
  ctx.fillRect(0, canvas.height/2 - 10, canvas.width, 20);
  ctx.globalAlpha = 1;

  // è£½é€ ãƒ©ã‚¤ãƒ³ã®é³©
  if(phase==="drop" || phase==="fry" || phase==="fall") {
    const img = (phase==="fry" || phase==="fall") ? hatoAgeImg : hatoImg;
    ctx.drawImage(img, hato.x, hato.y, hato.size, hato.size);
  }

  // å±±ç©ã¿
  for(let p of pile) {
    ctx.drawImage(hatoAgeImg, p.x, p.y, p.size, p.size);
  }

  // è½ä¸‹ä¸­ã®é³©
  for(let f of falling) {
    ctx.drawImage(hatoAgeImg, f.x, f.y, f.size, f.size);
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  if(pile.length >= count){
    message.textContent = `ğŸ‰ ã¯ã¨ã‚ã’å®Œæˆï¼(${pile.length}äºº) ğŸ‰`;
  } else {
    message.textContent = `ç¾åœ¨ ${pile.length}/${count} äºº â†’ ã¯ã¨ã‚ã’ ${pile.length}å€‹`;
  }

  requestAnimationFrame(loop);
}

function loop() {
  update();
  draw();
}
loop();
</script>
</body>
</html>
