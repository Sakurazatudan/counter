<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>桜落下アニメ</title>
<style>
  body { margin:0; overflow:hidden; background:#87CEEB; }
  canvas { display:block; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const petals = [];
const maxPetals = 200;

// 背景の木画像
const treeImg = new Image();
treeImg.src = 'tree.png'; // 自分で用意する木の画像

// 花びら画像
const petalImg = new Image();
petalImg.src = 'petal.png'; // 自分で用意する花びら画像

// 花びら生成
function spawnPetal() {
    const p = {
        x: Math.random() * canvas.width,
        y: -20,
        size: Math.random()*20 + 10,
        speed: Math.random()*1 + 0.5,
        angle: Math.random()*Math.PI*2,
        angularSpeed: (Math.random()-0.5)*0.02
    };
    petals.push(p);
}

// JSONから人数に応じて花びら生成
async function updatePetals() {
    try {
        const res = await fetch('member_count.json');
        const data = await res.json();
        const maxMembers = 1000;
        const ratio = Math.min(data.count/maxMembers,1);
        const target = Math.floor(ratio * maxPetals);

        while(petals.length < target){
            spawnPetal();
        }
    } catch(e){
        console.error(e);
    }
}

// 描画ループ
function animate(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // 背景の木
    ctx.drawImage(treeImg, canvas.width/2 - treeImg.width/2, canvas.height - treeImg.height);

    // 花びら更新＆描画
    petals.forEach(p=>{
        p.y += p.speed;
        p.x += Math.sin(p.angle)*0.5;
        p.angle += p.angularSpeed;

        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.angle);
        ctx.drawImage(petalImg, -p.size/2, -p.size/2, p.size, p.size);
        ctx.restore();
    });

    requestAnimationFrame(animate);
}

// 1秒ごとに人数確認
setInterval(updatePetals,1000);

animate();
</script>
</body>
</html>
