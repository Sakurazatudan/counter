<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã¯ã¨ã‚ã’è£½é€ ãƒ©ã‚¤ãƒ³+å±±ç©ã¿</title>
<style>
body { margin:0; overflow:hidden; background:#87CEEB; }
canvas { display:block; }
#message {
  position:absolute;
  top:20px;
  width:100%;
  text-align:center;
  font-size:2em;
  color:#fff;
  font-family:sans-serif;
  text-shadow: 1px 1px 3px #000;
}
</style>
</head>
<body>
<div id="message"></div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const message = document.getElementById('message');

const hatoImg = new Image();
hatoImg.src = 'hato.png';
const hatoAgeImg = new Image();
hatoAgeImg.src = 'hatoage_only.png';

let count = 0;   // JSONã®äººæ•°
let hato = { x: canvas.width/2 - 16, y: -50, state: "raw" };
let phase = "drop"; // drop â†’ fry â†’ fall â†’ fade â†’ pile
let fadeOpacity = 1.0;

// äººæ•°ã‚’å–å¾—
async function updateCount() {
  try {
    const res = await fetch("member_count.json");
    const data = await res.json();
    count = Math.min(data.count, 1000);
  } catch (e) {
    console.error(e);
    count = 123; // ãƒ‡ãƒ¢ç”¨ä»®å€¤
  }
}
updateCount();

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (phase!=="pile") {
    // è£½é€ ãƒ©ã‚¤ãƒ³ï¼ˆç°è‰²ï¼‹ç«èŠ±ï¼‰
    ctx.globalAlpha = fadeOpacity;
    ctx.fillStyle = "#555";
    ctx.fillRect(0, canvas.height/2 - 20, canvas.width, 40);
    ctx.globalAlpha = 1;
    for(let i=0;i<20;i++){
      ctx.fillStyle = `rgba(255,165,0,${Math.random()})`;
      ctx.fillRect(Math.random()*canvas.width, canvas.height/2 - 20 + Math.random()*40, 2, 2);
    }
  }

  if (phase==="drop") {
    hato.y += 4;
    ctx.drawImage(hatoImg, hato.x, hato.y, 32, 32);
    if (hato.y >= canvas.height/2 - 40) {
      phase = "fry";
    }

  } else if (phase==="fry") {
    ctx.drawImage(hatoAgeImg, hato.x, hato.y, 32, 32);
    setTimeout(()=>{ phase="fall"; }, 500);

  } else if (phase==="fall") {
    hato.y += 5;
    ctx.drawImage(hatoAgeImg, hato.x, hato.y, 32, 32);
    if (hato.y > canvas.height) {
      phase = "fade";
    }

  } else if (phase==="fade") {
    fadeOpacity -= 0.02;
    ctx.globalAlpha = fadeOpacity;
    ctx.fillStyle = "#555";
    ctx.fillRect(0, canvas.height/2 - 20, canvas.width, 40);
    ctx.globalAlpha = 1;
    if (fadeOpacity<=0) {
      phase="pile";
    }

  } else if (phase==="pile") {
    // å±±ç©ã¿
    const baseY = canvas.height - 150;
    const size = 32;
    for(let i=0;i<count;i++){
      const layer = Math.floor(i / 20);
      const offsetX = (i % 20) * (size+2) - (20*(size+2))/2;
      const x = canvas.width/2 + offsetX + Math.random()*3;
      const y = baseY - layer * (size/1.5) - Math.random()*3;
      ctx.drawImage(hatoAgeImg, x, y, size, size);
    }
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if(count>=1000){
      message.textContent="ğŸ‰ ã¯ã¨ã‚ã’å®Œæˆï¼ ğŸ‰";
    } else {
      message.textContent=`ç¾åœ¨ ${count} äºº â†’ ã¯ã¨ã‚ã’ ${count}å€‹`;
    }
  }

  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
        angle: Math.random()*Math.PI*2,
        angularSpeed: (Math.random()-0.5)*0.02
    };
    petals.push(p);
}

// JSONã‹ã‚‰äººæ•°ã«å¿œã˜ã¦èŠ±ã³ã‚‰ç”Ÿæˆ
async function updatePetals() {
    try {
        const res = await fetch('member_count.json');
        const data = await res.json();
        const maxMembers = 1000;
        const ratio = Math.min(data.count/maxMembers,1);
        const target = Math.floor(ratio * maxPetals);

        while(petals.length < target){
            spawnPetal();
        }
    } catch(e){
        console.error(e);
    }
}

// æç”»ãƒ«ãƒ¼ãƒ—
function animate(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // èƒŒæ™¯ã®æœ¨
    ctx.drawImage(treeImg, canvas.width/2 - treeImg.width/2, canvas.height - treeImg.height);

    // èŠ±ã³ã‚‰æ›´æ–°ï¼†æç”»
    petals.forEach(p=>{
        p.y += p.speed;
        p.x += Math.sin(p.angle)*0.5;
        p.angle += p.angularSpeed;

        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.angle);
        ctx.drawImage(petalImg, -p.size/2, -p.size/2, p.size, p.size);
        ctx.restore();
    });

    requestAnimationFrame(animate);
}

// 1ç§’ã”ã¨ã«äººæ•°ç¢ºèª
setInterval(updatePetals,1000);

animate();
</script>
</body>
</html>
