<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>落ちる桜の木</title>
<style>
body { margin:0; overflow:hidden; background:#111; }
canvas { display:block; }
</style>
</head>
<body>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.158/build/three.module.js';

let scene, camera, renderer;
let treeGroup, petals = [];

init();
animate();

function init(){
    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.set(3,3,5);
    camera.lookAt(0,1,0);

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const light = new THREE.DirectionalLight(0xffffff,1);
    light.position.set(5,5,5);
    scene.add(light);

    treeGroup = new THREE.Group();
    scene.add(treeGroup);

    createTrunk();
}

// 幹作成（固定）
function createTrunk(){
    const blockSize = 0.2;
    const trunkHeight = 5;
    for(let y=0; y<trunkHeight; y++){
        const geometry = new THREE.BoxGeometry(blockSize, blockSize, blockSize);
        const material = new THREE.MeshStandardMaterial({color:0x8B4513});
        const cube = new THREE.Mesh(geometry, material);
        cube.position.set(0, y*blockSize, 0);
        treeGroup.add(cube);
    }
}

// 花びら生成
function spawnPetal(maxHeight=3){
    const blockSize = 0.2;
    const geometry = new THREE.BoxGeometry(blockSize, blockSize, blockSize);
    const material = new THREE.MeshStandardMaterial({color:0xFFC0CB, transparent:true, opacity:0.8});
    const petal = new THREE.Mesh(geometry, material);

    // x,zはランダム、yは幹の上
    petal.position.set(
        (Math.random()-0.5)*2, 
        5*blockSize + Math.random()*maxHeight, 
        (Math.random()-0.5)*2
    );
    petal.velocityY = 0; // 落下速度
    petals.push(petal);
    treeGroup.add(petal);
}

// JSONから人数取得して花びら生成
async function generatePetals(){
    try{
        const res = await fetch('member_count.json');
        const data = await res.json();
        const maxMembers = 1000;
        const ratio = Math.min(data.count/maxMembers,1);
        const targetPetals = Math.floor(ratio*200); // 最大200枚

        while(petals.length < targetPetals){
            spawnPetal();
        }
    }catch(e){
        console.error(e);
    }
}

function animate(){
    requestAnimationFrame(animate);

    treeGroup.rotation.y += 0.002;
    treeGroup.position.y = Math.sin(Date.now()*0.001)*0.1;

    // 花びら落下
    petals.forEach(p => {
        p.velocityY -= 0.001; // 重力っぽく
        p.position.y += p.velocityY;

        if(p.position.y < 0){ // 地面に到達したら止める
            p.position.y = 0;
            p.velocityY = 0;
        }
    });

    generatePetals();

    renderer.render(scene,camera);
}
</script>
</body>
</html>
